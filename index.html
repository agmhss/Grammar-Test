<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grammar Guardian ‚úçÔ∏è</title>
<style>
  :root{--bg1:#f0f7ff;--card:#fff;--accent:#2b6cb0;--ok:#16a34a;--bad:#dc2626}
  html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),#e6f0ff);display:flex;align-items:center;justify-content:center;padding:12px}
  .wrap{width:100%;max-width:720px;background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(20,30,60,.12);padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap}
  header h1{margin:0;font-size:1.2rem;color:var(--accent)}
  .meta{margin-left:auto;text-align:right;font-size:.9rem}
  .score{font-weight:700;color:#0b6;display:block}
  .card{padding:14px;border-radius:10px;border:1px solid #eef5ff;background:linear-gradient(180deg,#fff,#fbfdff);margin-bottom:12px}
  .sentence{font-size:1.1rem;padding:10px;border-radius:8px;background:#f7fbff;border:1px dashed #dfeeff;min-height:48px;display:flex;align-items:center}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .opt{padding:10px;border-radius:8px;border:1px solid #e6eefc;background:white;cursor:pointer;user-select:none}
  .opt.selected{outline:3px solid rgba(43,108,176,.12)}
  .opt.correct{border-color:var(--ok);background:rgba(16,185,129,.06)}
  .opt.wrong{border-color:var(--bad);background:rgba(220,38,38,.04)}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn-ghost{background:#fff;border:1px solid #dbeefe;color:var(--accent)}
  .timer{font-weight:700;padding:6px 10px;border-radius:8px;background:#f1f7ff;border:1px solid #dbeefe}
  .progress{height:8px;background:#eef6ff;border-radius:8px;margin-top:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#2b6cb0,#4f9ae6);width:0%}
  .feedback{margin-top:8px;font-weight:700;min-height:22px}
  .hall{margin-top:10px;padding:10px;border-radius:8px;background:#fff7ef;border:1px solid #ffe8cc}
  .hof-list{margin-top:8px}
  .hof-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #fff2e6}
  .certificate{display:none}
  .hidden { display:none; }
  @media(max-width:520px){
    .options{grid-template-columns:1fr}
    header{gap:8px}
    .meta{text-align:left;margin-left:0}
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Grammar Guardian">
    <header>
      <div>
        <h1>Grammar Guardian ‚úçÔ∏è</h1>
        <div style="font-size:.88rem;color:#556">Fix sentences ‚Äî learn grammar in minutes</div>
      </div>
      <div class="meta" aria-live="polite">
        <div>Score: <span id="currentScore" class="score">0</span></div>
        <div>Best: <span id="bestScore">0</span></div>
      </div>
    </header>

    <div class="card" id="questionCard" aria-live="polite">
      <div class="sentence" id="sentence">Loading question...</div>

      <div class="options" id="options"></div>

      <div class="controls">
        <div class="timer" id="timer">Time: 20s</div>
        <button id="submitBtn">Submit Answer</button>
        <button id="skipBtn" class="btn-ghost">Skip</button>
        <div style="margin-left:auto;font-size:.9rem;color:#667">Q <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
      <div class="feedback" id="feedback" aria-live="polite"></div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button id="startBtn">Start Game</button>
      <button id="resetBtn" class="btn-ghost">Reset Scores</button>
      <button id="showHofBtn" class="btn-ghost">Show Hall of Fame</button>
    </div>

    <div class="hall hidden" id="hall" aria-live="polite">
      <strong>üèÜ Hall of Fame (Top 10)</strong>
      <div class="hof-list" id="hofList"></div>

      <div style="margin-top:10px">
        <div style="font-size:.95rem">If you make the top score, enter your name:</div>
        <input id="hofName" placeholder="Your name" style="padding:8px;border-radius:6px;border:1px solid #e1eefc;width:60%;margin-top:8px" maxlength="30"/>
        <button id="saveHofBtn" style="margin-left:8px">Save</button>
      </div>
    </div>

    <canvas id="certificate" class="certificate" width="1000" height="700"></canvas>
  </div>

<script>
/* ======= Question bank ======= */
const questions = [
  { sentence: "She ____ to the store every Saturday.", options:["go","goes","gone","going"], answer:1, explanation:"Third person singular (she) requires 'goes'." },
  { sentence: "They has finished their homework.", options:["have","has","had","having"], answer:0, explanation:"Subject 'they' takes 'have' not 'has'." },
  { sentence: "He don't like vegetables.", options:["doesn't","don't","didn't","not"], answer:0, explanation:"Third person singular (he) + negative ‚Üí 'doesn't'." },
  { sentence: "I have went to the market.", options:["went","gone","go","been"], answer:1, explanation:"Present perfect requires past participle 'gone'." },
  { sentence: "There is many books on the table.", options:["are","is","was","were"], answer:0, explanation:"Plural 'books' needs 'are'." },
  { sentence: "Who did you met yesterday?", options:["meet","met","meeting","meets"], answer:0, explanation:"After 'did' the base form 'meet' should be used." },
  { sentence: "She is as tall like her sister.", options:["as","like","than","so"], answer:0, explanation:"Correct comparative structure is 'as ... as'." },
  { sentence: "Each of the boys have a pen.", options:["has","have","is","are"], answer:0, explanation:"'Each' (singular) takes 'has'." },
  { sentence: "It's time we ____ to leave.", options:["go","went","gone","going"], answer:1, explanation:"Subjunctive: 'we went' (but often 'to go' used) ‚Äî accepted 'went'." },
  { sentence: "Please give the book to John and I.", options:["I","me","we","us"], answer:1, explanation:"Object of preposition should be 'me'." },
  { sentence: "She sang more beautifully than me.", options:["I","me","my","mine"], answer:0, explanation:"After 'than' in comparisons referring to subject, use 'I' (formal)." },
  { sentence: "If I will see him, I will tell you.", options:["see","saw","seen","seeing"], answer:0, explanation:"In 'if' clauses (first conditional) use present: 'If I see'." },
  { sentence: "Neither of the answers are correct.", options:["is","are","were","be"], answer:0, explanation:"'Neither' is singular ‚Üí 'is'." },
  { sentence: "I suggested him to study more.", options:["suggested him","suggested that he","suggested to him","suggested him to"], answer:1, explanation:"Use 'suggested that he study' or 'suggested to him' ‚Äî best: 'suggested that he'." },
  { sentence: "There is no any reason to worry.", options:["no any","any","not no any","no not any"], answer:1, explanation:"Correct: 'There is not any' or better 'There is no reason' but among options ' no any' fits the intended correction." },
  { sentence: "She is better than me at chess.", options:["me","I","my","mine"], answer:1, explanation:"Formally 'better than I (am)' is correct; 'me' is common but informal." },
  { sentence: "We visited Paris last year, didn't we?", options:["did","didn't","do","does"], answer:1, explanation:"Negative question tag for positive statement is 'didn't we'." },
  { sentence: "Everyone must bring their pencil.", options:["his or her","their","its","theirs"], answer:0, explanation:"Formal singular 'everyone' takes 'his or her' (or use 'their' in modern usage)."},
  { sentence: "I am interesting in music.", options:["interested","interesting","interest","interests"], answer:0, explanation:"Use adjective 'interested' (feeling) not 'interesting' (causing interest)." },
  { sentence: "He is one of the best player in the team.", options:["player","players","playing","plays"], answer:1, explanation:"One of the + plural noun ‚Üí 'players'." },
  { sentence: "They ____ dinner when the phone rang.", options:["have","had","were having","has"], answer:2, explanation:"The past continuous 'were having' describes an ongoing action interrupted by another." },{ sentence: "If it ____ tomorrow, we‚Äôll stay home.", options:["rains","rain","raining","rained"], answer:0, explanation:"In first conditional, present simple ('rains') follows 'if'." },
  { sentence: "I ____ a movie last night.", options:["see","saw","seen","seeing"], answer:1, explanation:"Past simple of 'see' is 'saw'." },
  { sentence: "He ____ to school by bus.", options:["go","goes","gone","going"], answer:1, explanation:"Third person singular takes 'goes'." },
  { sentence: "They ____ finished their homework yet.", options:["hasn't","haven't","didn't","aren't"], answer:1, explanation:"Use 'haven‚Äôt' with plural subject 'they'." },
  { sentence: "She ____ me since Monday.", options:["didn't call","wasn't calling","hasn't called","isn't calling"], answer:2, explanation:"Present perfect for actions continuing up to now." },
  { sentence: "The cake ____ delicious!", options:["smells","smelling","smell","smelled"], answer:0, explanation:"Use simple present for sensory verbs." },
  { sentence: "When I was a child, I ____ to the park daily.", options:["used to go","use to go","was used to go","am used to go"], answer:0, explanation:"'Used to' describes past habits." },
  { sentence: "Neither John nor his friends ____ coming.", options:["is","are","was","be"], answer:1, explanation:"Plural noun nearest to verb decides number; 'friends are coming'." },
  { sentence: "She sings better ____ her sister.", options:["then","than","that","as"], answer:1, explanation:"Comparison uses 'than'." },
  { sentence: "I wish I ____ a car.", options:["have","had","has","having"], answer:1, explanation:"Use past form 'had' for unreal present situations." },
  { sentence: "A bouquet of flowers ____ on the table.", options:["were","was","are","be"], answer:1, explanation:"'Bouquet' is singular, so 'was'." },
  { sentence: "We ____ dinner when she arrived.", options:["already had","had already had","were already having","has already had"], answer:1, explanation:"Past perfect before another past action." },
  { sentence: "He‚Äôs the man ____ helped us.", options:["who","which","whose","whom"], answer:0, explanation:"'Who' is used for people as subjects." },
  { sentence: "Let‚Äôs go, ____?", options:["will we","won‚Äôt we","shall we","don‚Äôt we"], answer:2, explanation:"Tag question after 'let‚Äôs' uses 'shall we'." },
  { sentence: "She prefers tea ____ coffee.", options:["than","to","over","from"], answer:1, explanation:"Correct preposition is 'to'." },
  { sentence: "By this time next year, I ____ graduated.", options:["will have","will has","will be","have"], answer:0, explanation:"Future perfect uses 'will have + past participle'." },
  { sentence: "I haven‚Äôt seen him ____ a week.", options:["since","for","from","in"], answer:1, explanation:"Use 'for' with duration." },
  { sentence: "The movie was so ____ that I watched it twice.", options:["bored","boring","interesting","interested"], answer:2, explanation:"'Interesting' describes things that cause interest." },
  { sentence: "She drives ____ than her brother.", options:["careful","carefully","more carefully","most carefully"], answer:2, explanation:"Use 'more carefully' for comparisons." },
  { sentence: "He‚Äôs looking forward to ____ you soon.", options:["see","seeing","to see","seen"], answer:1, explanation:"'Looking forward to' is followed by a gerund." },
  { sentence: "There isn‚Äôt ____ milk left.", options:["many","a few","some","much"], answer:3, explanation:"'Much' is used with uncountable nouns in negatives." },
  { sentence: "Each of the students ____ a book.", options:["have","has","having","had"], answer:1, explanation:"'Each' takes singular verb 'has'." },
  { sentence: "She asked me where I ____ going.", options:["am","was","were","be"], answer:1, explanation:"Reported speech shifts tense back: 'was going'." },
  { sentence: "You must finish it, ____ you?", options:["must","mustn‚Äôt","needn‚Äôt","will"], answer:1, explanation:"Tag question repeats the auxiliary in negative form." },
  { sentence: "The letter ____ by tomorrow.", options:["will send","is sent","will be sent","was sent"], answer:2, explanation:"Future passive: 'will be sent'." },
  { sentence: "If he ____ harder, he would pass.", options:["worked","works","working","work"], answer:0, explanation:"Second conditional uses past form after 'if'." },
  { sentence: "I‚Äôd rather you ____ now.", options:["leave","left","leaving","leaves"], answer:1, explanation:"'I'd rather you' is followed by past simple." },
  { sentence: "He made me ____ the truth.", options:["tell","to tell","told","telling"], answer:0, explanation:"'Make' + object + base verb form." },
  { sentence: "The test was easier than I ____.", options:["expected","expect","was expecting","had expect"], answer:0, explanation:"Past simple fits context." },
  { sentence: "She speaks English ____ than I do.", options:["good","better","best","well"], answer:1, explanation:"Comparative form is 'better'." },
  { sentence: "By the time we arrived, the movie ____.", options:["starts","had started","was started","started"], answer:1, explanation:"Past perfect before past action." },
  { sentence: "It‚Äôs important ____ your homework.", options:["doing","do","to do","done"], answer:2, explanation:"Use 'to + verb' after 'important'." },
  { sentence: "He‚Äôs been waiting ____ two hours.", options:["since","for","during","while"], answer:1, explanation:"'For' is used with a duration of time." },
  { sentence: "The baby started ____ when it heard the noise.", options:["cry","to cry","crying","cries"], answer:2, explanation:"'Start' can be followed by gerund or infinitive; 'crying' fits naturally here." },
  { sentence: "I prefer reading ____ watching TV.", options:["than","to","from","over"], answer:1, explanation:"Use 'to' with 'prefer'." },
  { sentence: "He‚Äôs the tallest boy ____ the class.", options:["of","in","at","from"], answer:1, explanation:"'In the class' is correct for location group." },
  { sentence: "She suggested ____ to the park.", options:["go","to go","going","gone"], answer:2, explanation:"'Suggest' is followed by a gerund." },
  { sentence: "If only I ____ more time!", options:["have","had","has","having"], answer:1, explanation:"'If only' uses past tense for unreal wish." },
  { sentence: "She told me she ____ tired.", options:["is","was","were","be"], answer:1, explanation:"Reported speech: change 'is' to 'was'." },
  { sentence: "They arrived ____ time to see the show.", options:["on","at","in","by"], answer:0, explanation:"'On time' means punctual." },
  { sentence: "He hasn‚Äôt finished yet, ____?", options:["hasn‚Äôt","has","didn‚Äôt","does"], answer:1, explanation:"Tag question after negative uses positive 'has'." },
  { sentence: "This book is ____ than that one.", options:["more interesting","interestinger","most interesting","interesting"], answer:0, explanation:"Correct comparative form is 'more interesting'." },
  { sentence: "We‚Äôll go for a walk if it ____ raining.", options:["stops","stop","stopped","stopping"], answer:0, explanation:"Present simple after 'if' in first conditional." },
  { sentence: "There are ____ apples in the basket.", options:["a few","few","little","much"], answer:0, explanation:"'A few' is used with countable plural nouns." },
  { sentence: "He promised ____ me tomorrow.", options:["help","to help","helping","helps"], answer:1, explanation:"'Promise' is followed by infinitive 'to help'." },
  { sentence: "The teacher asked us ____ quietly.", options:["to sit","sit","sitting","sat"], answer:0, explanation:"'Ask someone to do something' structure." },
  { sentence: "She can‚Äôt afford ____ a new car.", options:["buy","to buy","buying","bought"], answer:1, explanation:"'Afford' is followed by infinitive 'to buy'." },
  { sentence: "I look forward to ____ you soon.", options:["see","seeing","to see","seen"], answer:1, explanation:"'Look forward to' is followed by gerund." },
  { sentence: "He was late because he ____ the bus.", options:["miss","misses","missed","has missed"], answer:2, explanation:"Past simple fits with past reason." },
  { sentence: "She‚Äôs the woman ____ won the prize.", options:["who","which","whose","whom"], answer:0, explanation:"Use 'who' for people as subject." }
  { sentence:"He said ____ 'I will come tomorrow.'", options:[",",";","‚Äî",":"], answer:0, explanation:"Use a comma before direct speech." },
  { sentence:"Where are you going____", options:[".","?","!",";"], answer:1, explanation:"Questions end with a question mark." },
  { sentence:"Wow____ That was amazing!", options:[".","!","?",";"], answer:1, explanation:"Exclamatory sentences end with an exclamation mark." },
  { sentence:"It‚Äôs raining____ take an umbrella.", options:[",",";","!","?"], answer:1, explanation:"A semicolon joins two related independent clauses." },
  { sentence:"Bring the following____ pencils, pens, and paper.", options:[":",";","-","."], answer:0, explanation:"Use a colon to introduce a list." },
  { sentence:"She bought apples, oranges____ and bananas.", options:[",",";","-","."], answer:0, explanation:"Use commas to separate items in a list." },
  { sentence:"This is Ramesh‚Äôs book, not ____.", options:["Ram","Rams","Ram's","Rams'"], answer:2, explanation:"Apostrophe with ‚Äôs shows possession." },
  { sentence:"My brother____ who lives abroad____ is visiting soon.", options:[", ,","( )","--","; ;"], answer:2, explanation:"Use dashes for extra information." },
  { sentence:"We visited Paris in June____ the weather was perfect.", options:[",",";","!","."], answer:1, explanation:"Semicolon separates related independent clauses." },
  { sentence:"It was cold____ she wore a coat.", options:[",",";","?","!"], answer:1, explanation:"Semicolon connects two complete thoughts." }
  { sentence:"I can‚Äôt ____ to hear the news!", options:["wait","weight","waite","wate"], answer:0, explanation:"'Wait' means to stay or delay." },
  { sentence:"He hurt his ____ while running.", options:["heel","heal","he‚Äôll","hail"], answer:0, explanation:"'Heel' refers to the back of the foot." },
  { sentence:"Please ____ the door before you leave.", options:["close","clothes","cloze","closs"], answer:0, explanation:"'Close' means to shut." },
  { sentence:"She will read the story ____.", options:["to","too","two","tow"], answer:1, explanation:"'Too' means also." },
  { sentence:"The sun shines in the ____.", options:["morning","mourning","moaning","marine"], answer:0, explanation:"'Morning' refers to time of day." },
  { sentence:"We saw a ____ of birds.", options:["flock","flak","flocke","floke"], answer:0, explanation:"'Flock' means a group of birds." },
  { sentence:"I bought a new pair of ____.", options:["jeans","genes","jeens","geans"], answer:0, explanation:"'Jeans' are denim pants." },
  { sentence:"He threw the ball ____ the window.", options:["through","threw","thru","thrue"], answer:1, explanation:"'Threw' is past tense of 'throw'." },
  { sentence:"Please ____ the book to me.", options:["lend","land","lean","lane"], answer:0, explanation:"'Lend' means to give temporarily." },
  { sentence:"We went ____ the park.", options:["by","buy","bye","bee"], answer:0, explanation:"'By' indicates direction or location." }
  { sentence:"He will ____ the meeting at noon.", options:["address","speech","talk","speak"], answer:0, explanation:"'Address' can mean both to speak or a location." },
  { sentence:"The duck will ____ under the bridge.", options:["duck","go","move","hide"], answer:0, explanation:"'Duck' is both noun and verb." },
  { sentence:"Please ____ the leaves.", options:["park","rake","leave","pile"], answer:1, explanation:"'Rake' means both a tool and the action." },
  { sentence:"I saw a bat flying in the ____.", options:["dark","park","room","sky"], answer:0, explanation:"'Bat' can mean animal or sports equipment." },
  { sentence:"He can ____ very high.", options:["jump","can","dance","sing"], answer:1, explanation:"'Can' functions as modal and as a verb meaning 'able'." },
  { sentence:"The band will ____ at the concert.", options:["play","work","perform","act"], answer:0, explanation:"'Play' means both perform music and engage in activity." },
  { sentence:"The train will ____ at six.", options:["left","leave","live","lead"], answer:1, explanation:"'Leave' can mean go away or remain out." },
  { sentence:"The bark of the tree is rough.", options:["sound","voice","tree covering","leaf"], answer:2, explanation:"'Bark' means both tree covering and dog sound." },
  { sentence:"She can‚Äôt bear the pain.", options:["carry","endure","lift","ignore"], answer:1, explanation:"'Bear' can mean both tolerate and an animal." },
  { sentence:"He saw a bright light ____ the tunnel.", options:["in","at","end","through"], answer:2, explanation:"'Light' can mean both illumination and not heavy." }
  { sentence:"I stayed home ____ it was raining.", options:["because","so","but","though"], answer:0, explanation:"‚ÄòBecause‚Äô shows reason." },
  { sentence:"He is poor ____ honest.", options:["but","and","so","for"], answer:0, explanation:"‚ÄòBut‚Äô contrasts two ideas." },
  { sentence:"I was tired ____ I went to bed early.", options:["so","because","though","but"], answer:0, explanation:"‚ÄòSo‚Äô shows result." },
  { sentence:"She didn‚Äôt come ____ she was ill.", options:["because","so","though","and"], answer:0, explanation:"‚ÄòBecause‚Äô gives reason." },
  { sentence:"He worked hard ____ he failed.", options:["but","and","so","because"], answer:0, explanation:"‚ÄòBut‚Äô shows contrast." },
  { sentence:"You can come with me ____ stay here.", options:["or","and","so","but"], answer:0, explanation:"‚ÄòOr‚Äô shows choice." },
  { sentence:"I will call you ____ I reach home.", options:["when","so","because","though"], answer:0, explanation:"‚ÄòWhen‚Äô shows time." },
  { sentence:"He is tall ____ strong.", options:["and","so","or","but"], answer:0, explanation:"‚ÄòAnd‚Äô adds similar ideas." },
  { sentence:"She didn‚Äôt study hard; ____ she failed.", options:["therefore","though","because","but"], answer:0, explanation:"‚ÄòTherefore‚Äô shows consequence." },
  { sentence:"He runs fast ____ he is late.", options:["because","though","so","and"], answer:1, explanation:"‚ÄòThough‚Äô shows concession." }

];

/* ======= Game state ======= */
let qIndex = 0;
let score = 0;
let running = false;
let selected = null;
let timerInterval = null;
const timePerQ = 15; // seconds

/* ======= DOM ======= */
const sentenceEl = document.getElementById('sentence');
const optionsEl = document.getElementById('options');
const timerEl = document.getElementById('timer');
const feedbackEl = document.getElementById('feedback');
const submitBtn = document.getElementById('submitBtn');
const skipBtn = document.getElementById('skipBtn');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const qIndexEl = document.getElementById('qIndex');
const qTotalEl = document.getElementById('qTotal');
const progressBar = document.getElementById('progressBar');
const currentScoreEl = document.getElementById('currentScore');
const bestScoreEl = document.getElementById('bestScore');
const hallEl = document.getElementById('hall');
const showHofBtn = document.getElementById('showHofBtn');
const hofListEl = document.getElementById('hofList');
const saveHofBtn = document.getElementById('saveHofBtn');
const hofNameInput = document.getElementById('hofName');
const certCanvas = document.getElementById('certificate');

const BEST_KEY = 'grammarGuardianBest';
const HOF_KEY = 'grammarGuardianHOF';
const HOF_THRESHOLD = 6; // example: reach 6 to qualify

/* ======= Server endpoint (Apps Script Web App URL) ======= */
// Replace this with your deployed web app URL
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxSVfVnyP6gk7kr283_EeXnJV7GvGfsAlaEUpAE_WkVw58zYkCRf4qYQd1z4RDWz0oumw/exec';

/* ======= Helpers ======= */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }
function clearTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }
function getBest(){ return parseInt(localStorage.getItem(BEST_KEY) || '0',10); }
function setBest(v){ localStorage.setItem(BEST_KEY, String(v)); }

/* ======= Render ======= */
function renderQuestion(){
  if(qIndex >= questions.length){ endGame(); return; }
  selected = null;
  feedbackEl.textContent = '';
  const q = questions[qIndex];
  sentenceEl.textContent = q.sentence;
  optionsEl.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('div');
    btn.className = 'opt';
    btn.tabIndex = 0;
    btn.textContent = opt;
    btn.addEventListener('click', ()=> selectOption(i, btn));
    btn.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') selectOption(i, btn) });
    optionsEl.appendChild(btn);
  });
  qIndexEl.textContent = qIndex+1;
  qTotalEl.textContent = questions.length;
  updateProgress();
  startTimer(timePerQ);
}

function selectOption(i, el){
  // remove previous selection
  document.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selected = i;
  feedbackEl.textContent = '';
}

/* ======= Timer ======= */
function startTimer(seconds){
  clearTimer();
  let remaining = seconds;
  timerEl.textContent = `Time: ${remaining}s`;
  timerInterval = setInterval(()=> {
    remaining--;
    if(remaining < 0){ clearTimer(); timerEl.textContent = 'Time: 0s'; autoSubmit(); return; }
    timerEl.textContent = `Time: ${remaining}s`;
  },1000);
}

/* ======= Submit / scoring ======= */
function submitAnswer(){
  if(!running) return;
  const q = questions[qIndex];
  if(selected === null){ feedbackEl.textContent = 'Please choose an option or Skip.'; return; }
  clearTimer();
  const opts = document.querySelectorAll('.opt');
  opts.forEach((el, idx)=>{
    if(idx === q.answer) el.classList.add('correct');
    if(idx === selected && idx !== q.answer) el.classList.add('wrong');
  });
  if(selected === q.answer){
    score++;
    feedbackEl.textContent = '‚úÖ Correct! +' + 1;
    feedbackEl.style.color = '#0b6';
  } else {
    feedbackEl.textContent = '‚ùå Incorrect. ' + q.explanation;
    feedbackEl.style.color = '#b22222';
  }
  currentScoreEl.textContent = score;
  // update best if necessary
  const best = getBest();
  if(score > best){ setBest(score); bestScoreEl.textContent = score; }

  // move to next after delay
  setTimeout(()=> {
    qIndex++;
    if(qIndex < questions.length) renderQuestion(); else endGame();
  }, 1300);
}

function autoSubmit(){ // treat as wrong and move on
  feedbackEl.textContent = '‚è∞ Time up!';
  feedbackEl.style.color = '#b22222';
  // show correct
  const q = questions[qIndex];
  const opts = document.querySelectorAll('.opt');
  opts.forEach((el, idx)=> { if(idx === q.answer) el.classList.add('correct'); });
  setTimeout(()=> { qIndex++; if(qIndex < questions.length) renderQuestion(); else endGame(); }, 1000);
}

function updateProgress(){
  const pct = Math.round((qIndex / questions.length) * 100);
  progressBar.style.width = pct + '%';
}

/* ======= Game flow ======= */
function startGame(){
  shuffle(questions);
  qIndex = 0; score = 0;
  running = true;
  currentScoreEl.textContent = score;
  bestScoreEl.textContent = getBest();
  document.getElementById('feedback').textContent = '';
  renderQuestion();
}

function endGame(){
  running = false;
  clearTimer();
  feedbackEl.style.color = '#333';
  feedbackEl.textContent = `Game over ‚Äî your score: ${score}/${questions.length}.`;
  // if qualifies for HOF prompt
  if(score >= HOF_THRESHOLD){
    alert('Great job! You qualify for the Hall of Fame. Enter your name and press Save in the Hall of Fame panel.');
    hallEl.classList.remove('hidden');
    populateHOF(); // will fetch remote top10 and show local top as well
  }
  // show certificate option automatically
  generateCertificate();
}

/* ======= Hall of Fame (localStorage + remote) ======= */
function loadHOF(){ try{ return JSON.parse(localStorage.getItem(HOF_KEY) || '[]') }catch(e){ return [] } }
function saveHOF(list){ localStorage.setItem(HOF_KEY, JSON.stringify(list)); }

/* Render HOF: we will show remote top10 (if available) first */
async function populateHOF(){
  hofListEl.innerHTML = '<div style="padding:8px;color:#666">Loading...</div>';
  // try fetch remote top 10
  const remote = await fetchTop10().catch(()=>[]);
  hofListEl.innerHTML = '';
  if(remote && remote.length > 0){
    remote.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'hof-item';
      div.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div>${it.score}</div>`;
      hofListEl.appendChild(div);
    });
  } else {
    // fallback to local HOF
    const list = loadHOF().sort((a,b)=> b.score - a.score).slice(0,10);
    if(list.length === 0){
      hofListEl.innerHTML = '<div style="padding:8px;color:#666">No entries yet</div>';
      return;
    }
    list.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'hof-item';
      div.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div>${it.score}</div>`;
      hofListEl.appendChild(div);
    });
  }
}

/* Save HOF entry locally and remotely */
async function saveMyHOFEntry(){
  const name = (hofNameInput.value || 'Anonymous').trim();
  if(!name){ alert('Enter a name first'); return; }
  // save locally
  const list = loadHOF();
  list.push({ name, score, date: Date.now() });
  saveHOF(list);

  // attempt to save to remote server
  const serverResult = await submitScoreToServer(name, score);
  // serverResult is text (Apps Script returns simple text)
  console.log('Server save result:', serverResult);

  await populateHOF();
  alert('Saved to Hall of Fame (local + attempted remote).');
}

/* ======= Certificate generation (canvas) ======= */
function generateCertificate(){
  const ctx = certCanvas.getContext('2d');
  // background
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,certCanvas.width,certCanvas.height);
  // border
  ctx.strokeStyle = '#2b6cb0';
  ctx.lineWidth = 8;
  ctx.strokeRect(30,30,certCanvas.width-60,certCanvas.height-60);
  // title
  ctx.fillStyle = '#2b6cb0';
  ctx.font = '48px Georgia';
  ctx.fillText('Certificate of Achievement', 90, 160);
  // subtitle
  ctx.fillStyle = '#333';
  ctx.font = '28px Arial';
  ctx.fillText(`This certifies that`, 90, 240);
  // name
  const name = (hofNameInput.value || 'Player').toUpperCase();
  ctx.font = 'bold 46px Arial';
  ctx.fillStyle = '#0b6';
  ctx.fillText(name, 90, 310);
  // achievement
  ctx.font = '24px Arial';
  ctx.fillStyle = '#333';
  ctx.fillText(`scored ${score} out of ${questions.length} in Grammar Guardian`, 90, 370);
  // date
  const d = new Date().toLocaleDateString();
  ctx.font = '18px Arial';
  ctx.fillStyle = '#666';
  ctx.fillText(`Date: ${d}`, 90, certCanvas.height - 80);
  // show to user (open in new tab)
  certCanvas.toBlob(function(blob){
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    if(!w) alert('Certificate generated; popup blocked ‚Äî please allow popups to view.');
  });
}

/* ======= Utilities ======= */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ======= Server communication (Apps Script) ======= */
// submit a score (POST)
// Apps Script doPost returns plain text, so parse as text
async function submitScoreToServer(name, score){
  try {
    const res = await fetch(WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxSVfVnyP6gk7kr283_EeXnJV7GvGfsAlaEUpAE_WkVw58zYkCRf4qYQd1z4RDWz0oumw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, score })
    });
    const txt = await res.text();
    return txt;
  } catch (err) {
    console.error('Submit error', err);
    return null;
  }
}

// fetch top 10 (GET)
async function fetchTop10(){
  try {
    const res = await fetch(WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxSVfVnyP6gk7kr283_EeXnJV7GvGfsAlaEUpAE_WkVw58zYkCRf4qYQd1z4RDWz0oumw/exec');
    // Expecting JSON array from doGet
    const top10 = await res.json();
    return top10; // array of {date, name, score}
  } catch (err) {
    console.error('Fetch HOF error', err);
    return [];
  }
}

/* ======= Events ======= */
submitBtn.addEventListener('click', ()=> submitAnswer());
skipBtn.addEventListener('click', ()=> { clearTimer(); qIndex++; if(qIndex<questions.length) renderQuestion(); else endGame(); });
startBtn.addEventListener('click', ()=> { hallEl.classList.add('hidden'); startGame(); });
resetBtn.addEventListener('click', ()=> { if(confirm('Reset best score and Hall of Fame?')){ localStorage.removeItem(BEST_KEY); localStorage.removeItem(HOF_KEY); bestScoreEl.textContent='0'; populateHOF(); alert('Reset done.'); }});
showHofBtn.addEventListener('click', ()=> { hallEl.classList.toggle('hidden'); if(!hallEl.classList.contains('hidden')) populateHOF(); });
saveHofBtn.addEventListener('click', saveMyHOFEntry);

/* ======= Initialize UI ======= */
(function init(){
  bestScoreEl.textContent = getBest();
  qTotalEl.textContent = questions.length;
  currentScoreEl.textContent = score;
  // attach keyboard submit: Enter
  optionsEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') submitAnswer(); });
  // attempt to load remote HOF initially (non-blocking)
  window.addEventListener('load', populateHOF);
})();
</script>
</body>
</html>
