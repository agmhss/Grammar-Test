<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grammar Guardian ‚úçÔ∏è ‚Äì Improved</title>
<style>
  :root{--bg1:#f0f7ff;--card:#fff;--accent:#2b6cb0;--ok:#16a34a;--bad:#dc2626}
  html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),#e6f0ff);display:flex;align-items:center;justify-content:center;padding:12px}
  .wrap{width:100%;max-width:720px;background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(20,30,60,.12);padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap}
  header h1{margin:0;font-size:1.2rem;color:var(--accent)}
  .meta{margin-left:auto;text-align:right;font-size:.9rem}
  .score{font-weight:700;color:#0b6;display:block;font-size:1.4rem}
  .card{padding:14px;border-radius:10px;border:1px solid #eef5ff;background:linear-gradient(180deg,#fff,#fbfdff);margin-bottom:12px}
  .sentence{font-size:1.1rem;padding:10px;border-radius:8px;background:#f7fbff;border:1px dashed #dfeeff;min-height:48px;display:flex;align-items:center}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .opt{padding:10px;border-radius:8px;border:1px solid #e6eefc;background:white;cursor:pointer;user-select:none}
  .opt.selected{outline:3px solid rgba(43,108,176,.12)}
  .opt.correct{border-color:var(--ok);background:rgba(16,185,129,.06)}
  .opt.wrong{border-color:var(--bad);background:rgba(220,38,38,.04)}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn-ghost{background:#fff;border:1px solid #dbeefe;color:var(--accent)}
  .timer{font-weight:700;padding:6px 10px;border-radius:8px;background:#f1f7ff;border:1px solid #dbeefe}
  .progress{height:8px;background:#eef6ff;border-radius:8px;margin-top:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,#2b6cb0,#4f9ae6);width:0%}
  .feedback{margin-top:8px;font-weight:700;min-height:22px}
  .hall{margin-top:10px;padding:10px;border-radius:8px;background:#fff7ef;border:1px solid #ffe8cc}
  .hof-list{margin-top:8px}
  .hof-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #fff2e6}
  .certificate{display:none}
  .hidden { display:none; }
  .download-link{margin-top:10px;display:none}
  @media(max-width:520px){
    .options{grid-template-columns:1fr}
    header{gap:8px}
    .meta{text-align:left;margin-left:0}
    /* Ensure player details inputs stack on small screens */
    #playerDetails{flex-direction:column}
    #playerDetails input{flex:1 1 100%; width:100%}
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Grammar Guardian">
    <header>
      <div>
        <h1>Grammar Guardian ‚úçÔ∏è</h1>
        <div style="font-size:.88rem;color:#556">Fix sentences ‚Äî learn grammar in minutes</div>
      </div>
      <div class="meta" aria-live="polite">
        <!-- We display both raw score and percentage in the UI -->
        <div>Score: <span id="currentScore" class="score">0</span></div>
        <!-- Removed best score display -->
      </div>
    </header>

    <div class="card" id="questionCard" aria-live="polite">
      <div class="sentence" id="sentence">Loading question...</div>

      <div class="options" id="options"></div>

      <div class="controls">
        <!-- Timer removed -->
        <button id="submitBtn">Submit Answer</button>
        <button id="skipBtn" class="btn-ghost">Skip</button>
        <div style="margin-left:auto;font-size:.9rem;color:#667">Q <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
      <div class="feedback" id="feedback" aria-live="polite"></div>
    </div>

    <!-- Player details for certificate: Name, Class, Section -->
    <div id="playerDetails" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <input id="playerName" placeholder="Name" style="padding:8px;border-radius:6px;border:1px solid #e1eefc;flex:1 1 30%" maxlength="50" />
      <input id="playerClass" placeholder="Class" style="padding:8px;border-radius:6px;border:1px solid #e1eefc;flex:1 1 30%" maxlength="20" />
      <input id="playerSection" placeholder="Section" style="padding:8px;border-radius:6px;border:1px solid #e1eefc;flex:1 1 30%" maxlength="20" />
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button id="startBtn">Start Game</button>
      <!-- Reset button removed -->
      <button id="showHofBtn" class="btn-ghost">Show Hall of Fame</button>
    </div>

    <div class="hall hidden" id="hall" aria-live="polite">
      <strong>üèÜ Hall of Fame (Top 10)</strong>
      <div class="hof-list" id="hofList"></div>

      <div style="margin-top:10px">
        <div style="font-size:.95rem">If you make the top score, enter your name:</div>
        <input id="hofName" placeholder="Your name" style="padding:8px;border-radius:6px;border:1px solid #e1eefc;width:60%;margin-top:8px" maxlength="30"/>
        <button id="saveHofBtn" style="margin-left:8px">Save</button>
        <!-- Download HOF button removed -->
      </div>
    </div>

    <canvas id="certificate" class="certificate" width="1000" height="700"></canvas>
    <!-- link used to download the certificate -->
    <a id="certDownloadLink" class="download-link" download="certificate.png">Download Certificate</a>
  </div>

<script>
/* ======= Question bank ======= */
const questions = [
  // Subject-Verb Agreement
  { sentence: "She ____ to the store every Saturday.", chapter:"Subject-Verb Agreement", options:["go","goes","gone","going"], answer:1, explanation:"Third person singular (she) requires 'goes'." },
  { sentence: "They has finished their homework.", chapter:"Subject-Verb Agreement", options:["have","has","had","having"], answer:0, explanation:"Subject 'they' takes 'have' not 'has'." },
  { sentence: "He don't like vegetables.", chapter:"Subject-Verb Agreement", options:["doesn't","don't","didn't","not"], answer:0, explanation:"Third person singular (he) + negative ‚Üí 'doesn't'." },
  { sentence: "There is many books on the table.", chapter:"Subject-Verb Agreement", options:["are","is","was","were"], answer:0, explanation:"Plural 'books' needs 'are'." },
  { sentence: "He ____ a car.", chapter:"Subject-Verb Agreement", options:["drives","drive","driven","drove"], answer:0, explanation:"Third person singular 'he' takes 'drives'." },
  { sentence: "My friends ____ going to the party.", chapter:"Subject-Verb Agreement", options:["is","are","am","was"], answer:1, explanation:"Plural subject 'friends' takes 'are'." },
  { sentence: "The team ____ playing well.", chapter:"Subject-Verb Agreement", options:["is","are","were","have"], answer:0, explanation:"Collective noun 'team' is treated as singular here, so 'is'." },
  { sentence: "A bouquet of flowers ____ on the table.", chapter:"Subject-Verb Agreement", options:["is","are","were","have been"], answer:0, explanation:"The subject 'bouquet' is singular, so 'is'." },
  { sentence: "Either the teachers or the principal ____ attending.", chapter:"Subject-Verb Agreement", options:["is","are","were","was"], answer:0, explanation:"When subjects are joined by 'or', the verb agrees with the nearest subject 'principal', so 'is'." },
  { sentence: "There ____ a lot of people at the concert.", chapter:"Subject-Verb Agreement", options:["was","were","has","have"], answer:1, explanation:"The plural 'people' needs 'were'." },

  // Verb Tense
  { sentence: "I have went to the market.", chapter:"Verb Tense", options:["went","gone","go","been"], answer:1, explanation:"Present perfect requires past participle 'gone'." },
  { sentence: "She ____ breakfast already.", chapter:"Verb Tense", options:["ate","eaten","eats","is eating"], answer:1, explanation:"Present perfect uses past participle 'eaten'." },
  { sentence: "They ____ to school when it started raining.", chapter:"Verb Tense", options:["goes","were going","went","gone"], answer:1, explanation:"Past continuous uses 'were going'." },
  { sentence: "I ____ here since 2010.", chapter:"Verb Tense", options:["have lived","lived","live","am living"], answer:0, explanation:"'Since' with present perfect ‚Üí 'have lived'." },
  { sentence: "By next year, she ____ from college.", chapter:"Verb Tense", options:["will graduate","has graduated","will have graduated","graduates"], answer:2, explanation:"Future perfect ‚Üí 'will have graduated'." },
  { sentence: "He ____ a book every night.", chapter:"Verb Tense", options:["read","reads","reading","is reading"], answer:1, explanation:"Habitual action uses simple present 'reads'." },
  { sentence: "They ____ the project before the deadline last week.", chapter:"Verb Tense", options:["finish","finished","have finished","had finished"], answer:3, explanation:"Past perfect describes action before a past point: 'had finished'." },
  { sentence: "The sun ____ when we started our hike.", chapter:"Verb Tense", options:["rises","rose","had risen","is rising"], answer:2, explanation:"Past perfect describes an action completed before another past action: 'had risen'." },
  { sentence: "I ____ soccer tomorrow.", chapter:"Verb Tense", options:["will play","play","played","am playing"], answer:0, explanation:"Future tense: 'will play'." },
  { sentence: "We ____ each other since last year.", chapter:"Verb Tense", options:["haven't seen","didn't see","don't see","won't see"], answer:0, explanation:"Present perfect negative uses 'haven't seen'." },

  // Conjunctions
  { sentence:"You can come with me ____ stay here.", chapter:"Conjunctions", options:["or","and","so","but"], answer:0, explanation:"‚ÄòOr‚Äô shows choice." },
  { sentence:"I will call you ____ I reach home.", chapter:"Conjunctions", options:["when","so","because","though"], answer:0, explanation:"‚ÄòWhen‚Äô shows time." },
  { sentence:"He is thin ____ strong.", chapter:"Conjunctions", options:["and","so","or","but"], answer:3, explanation:"‚ÄòBut‚Äô shows contrast between qualities." },
  { sentence:"She didn‚Äôt study hard; ____ she failed.", chapter:"Conjunctions", options:["therefore","though","because","but"], answer:0, explanation:"‚ÄòTherefore‚Äô shows consequence." },
  { sentence:"He runs fast ____ he is late.", chapter:"Conjunctions", options:["because","though","so","and"], answer:0, explanation:"‚ÄòBecause‚Äô shows reason." },
  { sentence:"I wanted to go, ____ I was too busy.", chapter:"Conjunctions", options:["but","and","so","because"], answer:0, explanation:"‚ÄòBut‚Äô shows contrast." },
  { sentence:"She is smart ____ hardworking.", chapter:"Conjunctions", options:["and","but","or","because"], answer:0, explanation:"‚ÄòAnd‚Äô connects similar qualities." },
  { sentence:"I will go to bed early ____ I have to wake up at 6 AM.", chapter:"Conjunctions", options:["because","but","so","and"], answer:0, explanation:"‚ÄòBecause‚Äô gives reason." },
  { sentence:"He didn't study, ____ he failed the exam.", chapter:"Conjunctions", options:["and","so","because","but"], answer:1, explanation:"‚ÄòSo‚Äô expresses result." },
  { sentence:"You can have tea ____ coffee.", chapter:"Conjunctions", options:["or","and","but","so"], answer:0, explanation:"‚ÄòOr‚Äô indicates choice." },
  { sentence:"He was tired, ____ he continued working.", chapter:"Conjunctions", options:["but","and","so","because"], answer:0, explanation:"‚ÄòBut‚Äô shows contrast." },

  // Voice (Active/Passive)
  { sentence:"The letter ____ by him.", chapter:"Voice", options:["is written","was wrote","wrote","written"], answer:0, explanation:"Passive voice uses 'is written'." },
  { sentence:"The cake ____ by my mother.", chapter:"Voice", options:["is bake","was baked","were baked","is baked"], answer:1, explanation:"Past passive form: 'was baked'." },
  { sentence:"They will ____ the work.", chapter:"Voice", options:["complete","be completed","completed","be completing"], answer:0, explanation:"Future active voice uses 'will complete'." },
  { sentence:"The house ____ recently.", chapter:"Voice", options:["built","was built","is building","has built"], answer:1, explanation:"Past passive uses 'was built'." },

  // Prepositions
  { sentence:"He is good ____ math.", chapter:"Prepositions", options:["at","in","on","for"], answer:0, explanation:"The phrase is 'good at'." },
  { sentence:"She walked ____ the store.", chapter:"Prepositions", options:["into","in","onto","to"], answer:3, explanation:"We say 'walked to the store'." },
  { sentence:"They sat ____ the tree.", chapter:"Prepositions", options:["under","on","above","over"], answer:0, explanation:"We sit 'under' a tree for shade." },
  { sentence:"I will meet you ____ Monday.", chapter:"Prepositions", options:["on","in","at","by"], answer:0, explanation:"Use 'on' for days of the week." },

  // Modals
  { sentence:"You ____ open the window because it's stuffy.", chapter:"Modals", options:["should","must","shall","might"], answer:0, explanation:"'Should' is a polite suggestion when it's stuffy." },
  { sentence:"I ____ finish this by tomorrow.", chapter:"Modals", options:["can","could","might","must"], answer:3, explanation:"'Must' shows obligation." },
  { sentence:"____ you pass me the salt?", chapter:"Modals", options:["Could","Must","Should","Might"], answer:0, explanation:"'Could' is polite when making a request." },
  { sentence:"She ____ speak five languages.", chapter:"Modals", options:["can","may","should","must"], answer:0, explanation:"'Can' shows ability." },

  // Homonyms (commonly confused words)
  { sentence:"____ going to the park.", chapter:"Homonyms", options:["Their","There","They're","All of them"], answer:2, explanation:"The contraction 'They're' (they are) is correct." },
  { sentence:"I need to ____ some groceries.", chapter:"Homonyms", options:["buy","by","bye","buoy"], answer:0, explanation:"The correct word is 'buy'." },
  { sentence:"He read the book ____ fast.", chapter:"Homonyms", options:["too","two","to","top"], answer:0, explanation:"'Too' means excessively." },
  { sentence:"Please ____ those apples.", chapter:"Homonyms", options:["pair","pare","pear","pairs"], answer:1, explanation:"'Pare' means to trim or peel." },

  // Punctuation
  { sentence:"Which sentence is punctuated correctly?", chapter:"Punctuation", options:["I bought apples, oranges, and bananas.","I bought apples oranges, and bananas.","I bought, apples, oranges and bananas.","I bought apples oranges and bananas."], answer:0, explanation:"Use commas to separate items in a list." },
  { sentence:"Choose the correct sentence.", chapter:"Punctuation", options:["Its raining outside.","It's raining outside.","Its' raining outside.","It rains outside."], answer:1, explanation:"Use the contraction 'It's' (it is)." },
  { sentence:"Select the correctly punctuated sentence.", chapter:"Punctuation", options:["She said I love you.","She said, I love you.","She said, 'I love you.'","She said 'I love you'."], answer:2, explanation:"Use a comma and quotation marks around the spoken words." },
  { sentence:"Which is correct?", chapter:"Punctuation", options:["Whats your name?","What's your name?","Whats' your name?","What's youre name?"], answer:1, explanation:"Use the contraction 'What's' with an apostrophe." },

  // Connectors (transition words)
  { sentence:"I studied hard; ____, I passed the exam.", chapter:"Connectors", options:["however","therefore","meanwhile","although"], answer:1, explanation:"'Therefore' shows result." },
  { sentence:"He is rich; ____, he is unhappy.", chapter:"Connectors", options:["therefore","although","however","because"], answer:2, explanation:"'However' contrasts two clauses." },
  { sentence:"____ he was late, he still made an effort.", chapter:"Connectors", options:["Although","However","Furthermore","Therefore"], answer:0, explanation:"'Although' introduces a concessive clause." },
  { sentence:"She is talented; ____, she is humble.", chapter:"Connectors", options:["however","furthermore","although","therefore"], answer:1, explanation:"'Furthermore' adds supporting information." },

  // Homophones
  { sentence:"I will ____ a letter.", chapter:"Homophones", options:["write","right","rite","wright"], answer:0, explanation:"'Write' means to compose text." },
  { sentence:"The ____ smells good.", chapter:"Homophones", options:["flower","flour","flow","floor"], answer:0, explanation:"'Flower' is the correct noun." },
  { sentence:"He is the ____ of the school.", chapter:"Homophones", options:["principal","principle","prince","print"], answer:0, explanation:"'Principal' refers to the head of a school." },
  { sentence:"____ many cooks spoil the broth.", chapter:"Homophones", options:["Too","To","Two","Too."], answer:0, explanation:"'Too' means excessively." },
];

/* ======= Game state ======= */
let qIndex = 0;
let score = 0;
let running = false;
let selected = null;
// Timer removed: no countdown functionality

// Track performance per grammar chapter. chapterStats is an object
// keyed by chapter name with {correct:0,total:0}. It is initialized
// in startGame() and updated in submitAnswer() and when skipping.
let chapterStats = {};

// gameQuestions will hold a random subset of questions for each game (fixed number)
let gameQuestions = [];

// Store last game results to regenerate certificate with updated details
let lastFinalPctVal = 0;
let lastExcellentChapters = [];
let lastNeedsWorkChapters = [];

/* ======= DOM ======= */
const sentenceEl = document.getElementById('sentence');
const optionsEl = document.getElementById('options');
// const timerEl = document.getElementById('timer'); // timer element removed
const feedbackEl = document.getElementById('feedback');
const submitBtn = document.getElementById('submitBtn');
const skipBtn = document.getElementById('skipBtn');
const startBtn = document.getElementById('startBtn');
// const resetBtn = document.getElementById('resetBtn'); // removed: no reset button
const qIndexEl = document.getElementById('qIndex');
const qTotalEl = document.getElementById('qTotal');
const progressBar = document.getElementById('progressBar');
const currentScoreEl = document.getElementById('currentScore');
// bestScoreEl removed: no best score display
const hallEl = document.getElementById('hall');
const showHofBtn = document.getElementById('showHofBtn');
const hofListEl = document.getElementById('hofList');
const saveHofBtn = document.getElementById('saveHofBtn');
const downloadHofBtn = document.getElementById('downloadHofBtn');
const hofNameInput = document.getElementById('hofName');
const certCanvas = document.getElementById('certificate');
const certDownloadLink = document.getElementById('certDownloadLink');

// const BEST_KEY = 'grammarGuardianBest'; // removed best score storage key
const HOF_KEY = 'grammarGuardianHOF';
const HOF_THRESHOLD = 60; // percent threshold to qualify for HOF

/* ======= Helpers ======= */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }
// Timer removed: clearTimer is now a no-op
function clearTimer(){ }
// Provide positive remarks based on percentage to encourage players
function getRemark(pct){
  if(pct >= 90) return 'Outstanding performance! Keep it up!';
  if(pct >= 75) return 'Great job! Keep practicing.';
  if(pct >= 50) return 'Good effort! You\'re getting there.';
  if(pct > 0) return 'Nice try! Keep learning and you\'ll improve.';
  return 'Give it another shot, and keep practicing!';
}
// Removed getBest() and setBest() ‚Äì no longer tracking best score

/* ======= Render ======= */
function renderQuestion(){
  if(qIndex >= gameQuestions.length){ endGame(); return; }
  selected = null;
  feedbackEl.textContent = '';
  const q = gameQuestions[qIndex];
  sentenceEl.textContent = q.sentence;
  optionsEl.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('div');
    btn.className = 'opt';
    btn.tabIndex = 0;
    btn.textContent = opt;
    btn.addEventListener('click', ()=> selectOption(i, btn));
    btn.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') selectOption(i, btn) });
    optionsEl.appendChild(btn);
  });
  qIndexEl.textContent = qIndex+1;
  qTotalEl.textContent = gameQuestions.length;
  updateProgress();
  // Timer removed: no countdown per question
}

function selectOption(i, el){
  document.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selected = i;
  feedbackEl.textContent = '';
}

/* ======= Timer ======= */
// Timer removed: startTimer is now a no-op
function startTimer(seconds){ }

/* ======= Score Helpers ======= */
function calculatePercentage(){
  // percentage based on number of questions attempted (qIndex + 1) and correct answers (score)
  const attempted = Math.min(qIndex + 1, gameQuestions.length);
  if(attempted === 0) return 0;
  return (score / attempted) * 100;
}

function updateScoreDisplay(){
  const pct = calculatePercentage();
  // display percentage with 0 decimal for brevity
  // show number of attempted questions (qIndex+1)
  const attempted = Math.min(qIndex + 1, gameQuestions.length);
  currentScoreEl.textContent = `${pct.toFixed(0)}% (${score}/${attempted})`;
}

/* ======= Submit / scoring ======= */
function submitAnswer(){
  if(!running) return;
  const q = gameQuestions[qIndex];
  if(selected === null){ feedbackEl.textContent = 'Please choose an option or Skip.'; return; }
  // Timer removed: nothing to clear
  const opts = document.querySelectorAll('.opt');
  opts.forEach((el, idx)=>{
    if(idx === q.answer) el.classList.add('correct');
    if(idx === selected && idx !== q.answer) el.classList.add('wrong');
  });
  if(selected === q.answer){
    score++;
    feedbackEl.textContent = '‚úÖ Correct! +1';
    feedbackEl.style.color = '#0b6';
    // update chapter stats: increment correct and total for this chapter
    const chapter = q.chapter;
    if(chapterStats[chapter]){
      chapterStats[chapter].correct++;
      chapterStats[chapter].total++;
    }
  } else {
    feedbackEl.textContent = '‚ùå Incorrect. ' + q.explanation;
    feedbackEl.style.color = '#b22222';
    // update chapter stats: incorrect answer counts toward total only
    const chapter = q.chapter;
    if(chapterStats[chapter]){
      chapterStats[chapter].total++;
    }
  }
  // update display
  updateScoreDisplay();
  // best score tracking removed

  // move to next after delay
  setTimeout(()=> {
    qIndex++;
    if(qIndex < gameQuestions.length) renderQuestion(); else endGame();
  }, 1300);
}

// Timer removed: autoSubmit is no longer used
function autoSubmit(){ }

function updateProgress(){
  const pct = Math.round((qIndex / gameQuestions.length) * 100);
  progressBar.style.width = pct + '%';
}

/* ======= Game flow ======= */
function startGame(){
  // pick a random subset of 20 questions for this session
  const shuffled = [...questions];
  shuffle(shuffled);
  gameQuestions = shuffled.slice(0, 20);
  qIndex = 0;
  score = 0;
  running = true;
  currentScoreEl.textContent = '0% (0/0)';
  feedbackEl.textContent = '';
  // initialize chapterStats using selected game questions
  chapterStats = {};
  gameQuestions.forEach(q => {
    if(!chapterStats[q.chapter]){
      chapterStats[q.chapter] = { correct: 0, total: 0 };
    }
  });
  // update total questions display
  qTotalEl.textContent = gameQuestions.length;
  renderQuestion();
}

function endGame(){
  running = false;
  // Timer removed: nothing to clear
  // compute final percentage out of the number of selected questions
  const finalPctVal = (score / gameQuestions.length) * 100;
  const finalPct = finalPctVal.toFixed(0);
  const remark = getRemark(finalPctVal);
  feedbackEl.style.color = '#333';
  // Build summary of strengths and weaknesses per chapter
  const excellent = [];
  const needsWork = [];
  for(const chap in chapterStats){
    const stats = chapterStats[chap];
    if(stats.total > 0){
      const acc = stats.correct / stats.total;
      if(acc >= 0.7) excellent.push(chap);
      else if(acc <= 0.5) needsWork.push(chap);
    } else {
      // no attempts means user hasn't practiced this chapter
      needsWork.push(chap);
    }
  }
  let summaryMessage = '';
  if(excellent.length > 0){
    summaryMessage += ` Excellent in: ${excellent.join(', ')}.`;
  }
  if(needsWork.length > 0){
    summaryMessage += ` Needs more focus on: ${needsWork.join(', ')}.`;
  }
  feedbackEl.textContent = `Game over ‚Äî you scored ${finalPct}% (${score}/${gameQuestions.length}). ${remark}${summaryMessage}`;
  // if qualifies for HOF prompt (percent threshold)
  if(finalPctVal >= HOF_THRESHOLD){
    alert('Great job! You qualify for the Hall of Fame. Enter your name and press Save in the Hall of Fame panel.');
    hallEl.classList.remove('hidden');
    populateHOF(); // show local top10
  }
  // generate certificate automatically for convenience
  // pass the numeric percentage to certificate generator
  // store results for certificate regeneration
  lastFinalPctVal = finalPctVal;
  lastExcellentChapters = excellent;
  lastNeedsWorkChapters = needsWork;
  // generate initial certificate with current details
  generateCertificate(finalPctVal, excellent, needsWork);
}

/* ======= Hall of Fame (localStorage only) ======= */
function loadHOF(){ try{ return JSON.parse(localStorage.getItem(HOF_KEY) || '[]') }catch(e){ return [] } }
function saveHOF(list){ localStorage.setItem(HOF_KEY, JSON.stringify(list)); }

function populateHOF(){
  hofListEl.innerHTML = '';
  const list = loadHOF().sort((a,b)=> b.score - a.score).slice(0,10);
  if(list.length === 0){
    hofListEl.innerHTML = '<div style="padding:8px;color:#666">No entries yet</div>';
    return;
  }
  list.forEach((it, idx) => {
    const div = document.createElement('div');
    div.className = 'hof-item';
    div.innerHTML = `<div>${idx+1}. ${escapeHtml(it.name)}</div><div>${it.score.toFixed(0)}%</div>`;
    hofListEl.appendChild(div);
  });
}

/* Save HOF entry locally */
function saveMyHOFEntry(){
  const name = (hofNameInput.value || 'Anonymous').trim();
  if(!name){ alert('Enter a name first'); return; }
  const percentage = ((score / gameQuestions.length) * 100);
  // save locally
  const list = loadHOF();
  list.push({ name, score: percentage });
  saveHOF(list);
  populateHOF();
  alert('Saved to Hall of Fame.');
}

/* Download Hall of Fame data as JSON */
function downloadHOFData(){
  const data = JSON.stringify(loadHOF(), null, 2);
  const blob = new Blob([data], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'hall_of_fame.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ======= Certificate generation (canvas) ======= */
function generateCertificate(finalPctVal, excellentChapters = [], needsWorkChapters = []){
  const ctx = certCanvas.getContext('2d');
  // clear canvas
  ctx.clearRect(0,0,certCanvas.width,certCanvas.height);
  // background
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,certCanvas.width,certCanvas.height);
  // border
  ctx.strokeStyle = '#2b6cb0';
  ctx.lineWidth = 8;
  ctx.strokeRect(30,30,certCanvas.width-60,certCanvas.height-60);
  // Fetch name, class, and section from inputs for the certificate
  const nameInput = document.getElementById('playerName');
  const classInput = document.getElementById('playerClass');
  const sectionInput = document.getElementById('playerSection');
  // Try to get the player's name from the dedicated input; fall back to the Hall of Fame name input if blank.
  let nameVal = '';
  if(nameInput && nameInput.value){
    nameVal = nameInput.value;
  }
  if(!nameVal){
    const hofNameEl = document.getElementById('hofName');
    if(hofNameEl && hofNameEl.value){
      nameVal = hofNameEl.value;
    }
  }
  if(!nameVal){
    nameVal = 'Player';
  }
  const name = nameVal.toUpperCase();
  const classVal = classInput && classInput.value ? classInput.value : '';
  const sectionVal = sectionInput && sectionInput.value ? sectionInput.value : '';

  // header with institution name, centered
  ctx.fillStyle = '#2b6cb0';
  ctx.font = '40px Georgia';
  let text = 'AGMHSS Patteeswaram 612703';
  let metrics = ctx.measureText(text);
  let x = (certCanvas.width - metrics.width) / 2;
  ctx.fillText(text, x, 100);
  // title (larger), centered
  ctx.font = '60px Georgia';
  text = 'Certificate of Achievement';
  metrics = ctx.measureText(text);
  x = (certCanvas.width - metrics.width) / 2;
  ctx.fillText(text, x, 170);
  // subtitle (centered as well)
  ctx.fillStyle = '#333';
  ctx.font = '32px Arial';
  text = 'This certifies that';
  metrics = ctx.measureText(text);
  x = (certCanvas.width - metrics.width) / 2;
  ctx.fillText(text, x, 230);
  // name (bold, left aligned at 90)
  ctx.font = 'bold 46px Arial';
  ctx.fillStyle = '#0b6';
  ctx.fillText(name, 90, 290);
  // class and section line
  ctx.font = '24px Arial';
  ctx.fillStyle = '#333';
  let classSectionLine = '';
  if(classVal){ classSectionLine += `Class: ${classVal}`; }
  if(sectionVal){
    if(classSectionLine) classSectionLine += '   ';
    classSectionLine += `Section: ${sectionVal}`;
  }
  if(classSectionLine){
    ctx.fillText(classSectionLine, 90, 330);
  }
  // score line
  const pctRounded = finalPctVal.toFixed(0);
  ctx.font = '24px Arial';
  ctx.fillStyle = '#333';
  ctx.fillText(`scored ${pctRounded}% (${score}/${gameQuestions.length}) in Grammar Guardian`, 90, classSectionLine ? 370 : 340);
  // remark line
  const remark = getRemark(finalPctVal);
  ctx.font = '20px Arial';
  ctx.fillStyle = '#555';
  // position remark below previous line
  const remarkY = classSectionLine ? 410 : 380;
  ctx.fillText(remark, 90, remarkY);
  // strengths/weakness lines (wrap text if necessary)
  const messages = [];
  if(excellentChapters.length > 0){
    messages.push('Excellent in: ' + excellentChapters.join(', ') + '.');
  }
  if(needsWorkChapters.length > 0){
    messages.push('Needs more focus on: ' + needsWorkChapters.join(', ') + '.');
  }
  ctx.font = '20px Arial';
  ctx.fillStyle = '#444';
  // wrap text to fit within 800px width
  const maxWidth = certCanvas.width - 180;
  // Start drawing strengths/weakness messages below the remark
  let y = remarkY + 40;
  messages.forEach(msg => {
    const words = msg.split(' ');
    let line = '';
    words.forEach(word => {
      const testLine = line + word + ' ';
      const metrics = ctx.measureText(testLine);
      if(metrics.width > maxWidth){
        ctx.fillText(line.trim(), 90, y);
        y += 30;
        line = word + ' ';
      } else {
        line = testLine;
      }
    });
    if(line){
      ctx.fillText(line.trim(), 90, y);
      y += 30;
    }
  });
  // date
  const d = new Date().toLocaleDateString();
  ctx.font = '18px Arial';
  ctx.fillStyle = '#666';
  ctx.fillText(`Date: ${d}`, 90, certCanvas.height - 80);
  // convert to data URL and set download link. Using data URL ensures the
  // certificate can be downloaded without internet connection or revoked objects.
  const dataURL = certCanvas.toDataURL('image/png');
  certDownloadLink.href = dataURL;
  certDownloadLink.style.display = 'inline-block';
}

/* ======= Utilities ======= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };
    return map[m];
  });
}

/* ======= Events ======= */
submitBtn.addEventListener('click', ()=> submitAnswer());
skipBtn.addEventListener('click', ()=> {
  if(!running) return;
  // update chapter stats for skipped question
  const q = gameQuestions[qIndex];
  const chapter = q.chapter;
  if(chapterStats[chapter]){
    chapterStats[chapter].total++;
  }
  qIndex++;
  // update score display to reflect attempted question increase (score unchanged)
  updateScoreDisplay();
  if(qIndex < gameQuestions.length){
    renderQuestion();
  } else {
    endGame();
  }
});
startBtn.addEventListener('click', ()=> { hallEl.classList.add('hidden'); startGame(); });
// reset button removed ‚Äì no event needed
showHofBtn.addEventListener('click', ()=> { hallEl.classList.toggle('hidden'); if(!hallEl.classList.contains('hidden')) populateHOF(); });
saveHofBtn.addEventListener('click', saveMyHOFEntry);
// downloadHofBtn removed: no event binding

/* ======= Initialize UI ======= */
(function init(){
  // display the fixed number of questions (20) before the game starts
  qTotalEl.textContent = 20;
  currentScoreEl.textContent = '0% (0/0)';
  optionsEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') submitAnswer(); });
  // hide certificate download link until generated
  certDownloadLink.style.display = 'none';
  // regenerate certificate on download click to reflect current name/class/section
  certDownloadLink.addEventListener('click', function(){
    if(lastFinalPctVal !== undefined){
      generateCertificate(lastFinalPctVal, lastExcellentChapters, lastNeedsWorkChapters);
    }
  });
  populateHOF();
})();
</script>
</body>
</html>
